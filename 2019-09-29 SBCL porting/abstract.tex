%encoding UTF-8
\author{Игорь Чудов}
\city{Саратов}
\affiliation{Базальт СПО}
\projecttitle{SBCL}
\projecturl{\url{http://www.sbcl.org/}}
\title{Проблемы портирования SBCL на новые аппаратные платформы}
\maketitle

\begin{abstract}
  В докладе рассмотрена "проблема бутстрапа" реализации компилятора
  языка программирования Common LISP --- SBCL (Steel Bank Common LISP)
  в приложении к архитектуре e2k. Рассмотрены составные элементы данного
  ПО, этапы бутстрапа, а также некоторые подробности низкоуровневого
  устройства. Данная работа призвана объединить разрозенные знания об
  устройстве проекта.
\end{abstract}


\section{Проблематика}

В целях портирования компилятора SBCL на архитектуру e2k было начато
исследование проекта.

В процессе работы было обнаружено, что полноценное портирование на новые
архитектуры выполняется достаточно редко, а портирование на архитектуры
типа MIPS может выполняться по остаточному принципу в коде. В результате
в новых версиях программы поддержка конкретной архитектуры может не
гарантироваться.

Так как писать компилятор языка программирования на этом же языке
программирования является достаточно популярной тенденцией - при
возникновении новых архитектур возникает "проблема бутстрапа", которую
иногда называют проблемой "курицы и яйца". SBCL также подвержен данной
проблеме, но в относительно небольшой степени.


\section{Устройство и этапы сборки}

Бутстрап SBCL невозможен без существования интерпретатора Common LISP,
но на начальном этапе достаточно иметь таковой на хостовой платформе.
Для собственно инициализации сборки в таком случае необходим компилятор
C, ассемблер и линкер для целевой платформы.

Простейший процесс сборки для новой платформы выглядит так:

\begin{enumerate}
\item Создание файлов конфигурации для сборки ( \Q{make-config.sh} );
\item Сборка кросс-компилятора Common LISP. Данная часть называется
GENESIS 1;
\item Сборка компонентов целевого компилятора: эта часть собирается после
GENESIS 1, чтобы получить файл \Q{sbcl.h} для сборки части, написанной на
С, и до сборки GENESIS 2, чтобы получить таблицу символов.
\item Запускается кросс-компилятор для получения объектных файлов для
целевой операционной платформы.
\item Запускается GENESIS 2, чтобы получить \Q{cold-sbcl.core}.
Создаётся с помощью \Q{src/compiler/generic/genesis.lisp}, который
преобразует FASL файлы в образ LISP-системы на хосте.
\item Производится warm init - загрузка и сборка CLOS
( \EN{Common LISP Object System} ), а также компонентов, от неё зависящих.
\end{enumerate}

Для успешного прохождения всех этапов необходимо реализовать часть
системы, которая зависит от целевой архитектуры.


\section{Части системы}

SBCL технически является компилятором - каждое поступающее на вход
выражение сначала проходит этап компиляции в двоичный код, и только потом
исполняется. Соответственно, для выполнения этой задачи в SBCL
существует платформо-зависимая часть.

Платформо-зависимая часть состоит из определения регистров в файле
\Q{src/runtime/platformname-lispregs.h} , где \Q{platformname} -
название целевой архитектуры. Этот элемент необходим для описания
доступных для работы регистров.

Также существует ассемблерная часть в файле
\Q{src/runtime/platformname-assem.S}, где определены всего две функции -
\Q{call_into_c} и \Q{call_into_lisp}, которые выполняют переключение
между C и SBCL ABI. Одна из задач этой части - переключение на
C runtime, который отвечает за обработку сигналов, полученныx от
операционной системы. Для реализации таковых функций необходимо хорошее
знание \EN{platform ABI} целевой архитектуры, а также особенностей
целевой операционной системы.

Самая объёмная и сложная платформо-зависимая часть системы находится в
директориях \Q{src/assembly/platformname} и \Q{src/compiler/platformname}
и содержит определения виртуальных операций (VOP) которые необходимы,
чтобы преобразовать код на LISP в ассемблерный код, и используются в
виртуальной машине SBCL в качестве низкоуровневых операций для
в стандартных функциях ANSI Common LISP.

Одним из плюсов использования \EN{Virtual OPerations} является
возможность получать детализированные ассемблерные листинги при вызове
дизассемблирования.


\section{Проблемы при портировании на архитектуру e2k}

В ситуации с портированием SBCL на архитектуру e2k в ОС ALT Linux были
обнаружены следующие проблемы:

\begin{itemize}
\item Отсутствие кросс-компилятора C. Многие компиляторы, как SBCL, GHC
и другие, не рассчитаны на сборку только на целевой платформе;
\item Отсутствие детальной документации на C ABI для e2k. Данное знание
необходимо для реализации функции переключения между SBCL ABI и C ABI,
а также для эффективной реализации VOPs. Некоторые вещи приходится
изучать методом исследования ассемблерных листингов;
\item Частично утеряна документация по SBCL internals. К сожалению,
лучшее средство изучения проекта - чтение кода и общение в списках
рассылки;
\item Сложность ручного просчёта блоков инструкций для широких слов.
Ассемблер e2k плохо подходит для написания кода вручную;
\end{itemize}


\section{Библиография}

\begin{thebibliography}{9}
\bibitem{cliki} SBCL Internals CLiki site.
\url{https://web.archive.org/web/20120814000933/http://sbcl-internals.cliki.net/index}
\end{thebibliography}


%%% Local Variables: 
%%% mode: latex
%%% TeX-master: "../main"
%%% End: 
